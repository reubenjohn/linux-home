#!/bin/bash

envrc-generate() {
    # Source .env folder
    SOURCE_ENV_FOLDER="$HOME/.home/.env"
    ENV_FOLDER="$HOME/.env/src"
    ENV_RC="$HOME/.env/envrc"

    # Create .env folder in the user home if it doesn't already exist
    mkdir -p "$ENV_FOLDER"
    echo "ðŸ“‚ Created .env folder in $HOME/.env (if it didn't already exist)"

    # Softlink all files from the .env folder in this repository into the destination .env folder
    for file in $(find "$SOURCE_ENV_FOLDER" -type f | sort); do
        ln -sf "$file" "$ENV_FOLDER/$(basename $file)"
        echo "ðŸ”— Softlinked '$file' to '$ENV_FOLDER/$(basename $file)'"
    done

    # Concatenate all the files into an .envrc file
    echo "#!/bin/bash" > "$ENV_RC"
    echo "# This file is autogenerated. Please do not modify this file." >> "$ENV_RC"
    echo "# To regenerate this file from the other .env/ files, run envrc-generate" >> "$ENV_RC"
    echo "ðŸ“ Created '$ENV_RC' with a warning message"

    if [ -n "$(ls -A $ENV_FOLDER/)" ]; then
        for file in $(find "$SOURCE_ENV_FOLDER" -type f | sort); do
            cat "$file" >> "$ENV_RC"
            echo "âž• Appended '$file' to '$ENV_RC'"
        done
        echo "ðŸ“„ Concatenated all files from $SOURCE_ENV_FOLDER/ into '$ENV_RC'"
    fi
    echo "âœ… You may now run 'source ~/.env/envrc'"
}

envrc-source() {
    source "$HOME/.env/envrc" || echo "Failed to source ~/.env/envrc ; Did you forget to run envrc-generate?"
}

envrc-source
